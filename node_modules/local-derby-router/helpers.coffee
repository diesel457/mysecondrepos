dotty = require 'dotty'
placeholderRegex = /((?:\:[\w-\?\(\)\|]+)|(?:\*))\/?/

pathFor = (routes, path, options...) ->
  unless path?
    throw new Error "No controller:action provided"
  sections = path.split(':')

  # Simple hierarchy. Derby app will usually have only controller:action
  # 'controller:action' or 'controller'
  if sections.length <= 2
    [controller, action] = sections
    action ?= 'index'
    route = routes[controller]?[action]

  # Complex hierarchy
  # Express app may have
  else
    route = dotty.get routes, sections

  unless route
    throw new Error "No action found for '#{path}'"

  for option, index in options
    placeholder = route.match(placeholderRegex)?[1]
    unless placeholder
      throw new Error 'Url doesn\'t contain a :-placeholder for passed value'
    route = route.replace placeholder, option

  # Remove all optional placeholder sections from the path that left
  while placeholder = route.match(placeholderRegex)?[1]
    if placeholder.indexOf('?') is -1
      throw new Error 'No value specified for required placeholder ' + placeholder
    if route.indexOf(placeholder) is route.indexOf(placeholder + '/')
      placeholder += '/'
    route = route.replace placeholder, ''

  route


module.exports.pathFor = pathFor

var nconf = require('nconf')
  , path = require('path')
  , fs = require('fs')
  , _ = require('lodash')
  , app = process.env.APP
  , stage = process.env.STAGE;

module.exports = function(dirname) {

  var addNconfFile = function (nconf, filename) {
    var filePath = path.join(dirname, 'config', filename + '.json');
    if (fs.existsSync(filePath)) {
      nconf.file(filePath);
      return true;
    }
    console.log('Warning! APP and/or STATE are provided but config file ' +
      'wasn\'t found: ' + filePath);
    return false;
  };

  nconf.env();
  if (app && stage) addNconfFile(nconf, app + '_' + stage);
  else if (stage)   addNconfFile(nconf, stage);
  else if (app)     addNconfFile(nconf, app);

  nconf.defaults(require(dirname + '/config.json'));

  // Copy stuff required in Derby-part and vendor libs into ENV
  if (_.isArray(nconf.get('COPY_TO_ENV'))) {
    _.each(nconf.get('COPY_TO_ENV'), function (option) {
      process.env[option] = nconf.get(option);
    });
  }

  // Copy public env vars into global.env
  if (_.isArray(nconf.get('PUBLIC'))) {
    global.env || (global.env = {});
    _.each(nconf.get('PUBLIC'), function (option) {
      global.env[option] = nconf.get(option);
    });
  }

};

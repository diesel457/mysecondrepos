_ = require 'lodash'
express = require 'express'
Controller = require './controller'

module.exports = (options) ->

  _.defaults options,
    validation: {}
    hooks: {}
    paymentsCollection: 'payments'
    keys:
      secret: undefined
      publishable: undefined
    url: '/api/pay'

  unless options.keys.secret and options.keys.publishable
    throw new Error '[dm-stripe] No secret and/or publishable keys specified.' +
        'Please read README'

  controller = new Controller options

  router = express.Router()

  # Pipe some config values to client
  router.use (req, res, next) ->
    model = req.getModel()
    model.setEach '_session._plugins.stripe',
      publishable: options.keys.publishable
      url: options.url
      plans: _.pick options.validation, _.isNumber
    next()

  router.post options.url, controller.pay.bind(controller)

  router